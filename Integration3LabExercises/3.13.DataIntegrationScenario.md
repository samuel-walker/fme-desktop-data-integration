<!--Exercise Section-->

<table style="border-spacing: 0px;border-collapse: collapse;font-family:serif">
<tr>
<td width=25% style="vertical-align:middle;background-color:darkorange;border: 2px solid darkorange">
<i class="fa fa-cogs fa-lg fa-pull-left fa-fw" style="color:white;padding-right: 12px;vertical-align:text-top"></i>
<span style="color:white;font-size:x-large;font-weight: bold"></span>
</td>
<td style="border: 2px solid darkorange;background-color:darkorange;color:white">
<span style="color:white;font-size:x-large;font-weight: bold">Data Integration Scenario</span>
</td>
</tr>

<tr>
<td style="border: 1px solid darkorange; font-weight: bold">Data</td>
<td style="border: 1px solid darkorange">City of Vancouver Open Data (see table below)</td>
</tr>

<tr>
<td style="border: 1px solid darkorange; font-weight: bold">Overall Goal</td>
<td style="border: 1px solid darkorange">Use your FME skills to integrate data from several sources to solve a problem.</td>
</tr>

<tr>
<td style="border: 1px solid darkorange; font-weight: bold">Demonstrates</td>
<td style="border: 1px solid darkorange">Content Transformation, Structural Transformation, Schema Editing</td>
</tr>

<tr>
<td style="border: 1px solid darkorange; font-weight: bold">Start Workspace</td>
<td style="border: 1px solid darkorange">None</td>
</tr>

<tr>
<td style="border: 1px solid darkorange; font-weight: bold">End Workspace</td>
<td style="border: 1px solid darkorange">None. Instructors can access final workspace <a href="">here</a>.</td>
</tr>

</table>

## Introduction

In the previous exercises you have learned how to translate and transform data using FME. Now let's put that knowledge to use! As we covered in the [Lecture section](Integration1Lecture\1.00.Lecture.md), data integration is a key requirement for modern organizations. In this exercise you will develop a workspace that solves a data integration problem. There are three scenarios to choose from: business intelligence, city government, or web data. All three have the same requirements:
-inspect your data
-combine your datasets
-query your data to answer a question or solve a problem
-produce a deliverable and report showing your results

This exercise offers less guidance than the previous ones; you will have to explore FME for yourself in order to solve the problem. To get started, we will provide an example of integrating one dataset into a central database. After that you can follow similar steps for the remaining datasets. If you have trouble carrying out the steps you can refer to the FME Workbench Help (also available online in our [Documentation](https://support.safe.com/KnowledgeDocumentation)) or the community [Knowledge Center](https://knowledge.safe.com/).

## Exercise Goals

Your final challenge is to identify a possible problem based on your scenario and come up with a data integration solution.

You will have to explain the problem and solution you identified in a short report. Additionally, you must find a way to illustrate the benefits of your data integration solution by creating a deliverable: a map, table, or description of a new organizational process made possible by the solution. You can create this output using FME only, or you can bring the data created in FME into another program, e.g. ArcGIS, Adobe Illustrator, web mapping (e.g. GeoJSON in Google Maps, Leaflet, Mapbox, etc.), Google Earth, Tableau, Qlik, QGIS, etc. If this software is not available to you, take a screenshot of the Data Inspector that shows your result.

Here are the scenarios:

Scenario|Problem
--|--
Business intelligence|You are a healthcare administrator with patient records describing length of hospital stay and other attributes. You also have data on the postcode where the patients live. Integrate this data with StatsCan demographic data to examine links between demographics, geography, and length of hospital stay. Produce a map and a chart or table showing your results.
City Government|The federal government has just announced a subsidy for building electric vehicle charging stations. The City of Vancouver Planning department has been tasked with identifying suitable locations for the stations. The city has money to build 4 stations; they must be on city-owned property; they must be near areas of high population density; they must be located near major intersections; and they must be spread out evenly. Integrate data to propose four locations.
Web-based data|You have developed a new application that generates a GeoJSON of recent killer whale sightings off the coast of Vancouver. However, you don't want a blank basemap under your data. Use FME to add some more data to your map and use it to find correlations with whale sightings. **Note:** this scenario lends itself to using [FME Server](https://www.safe.com/fme/fme-server/) for reading and writing data live. You can try to use this software if you have it available. Otherwise you can construct a workspace that generates a static map.

## City Government

### Inspect Data

To start off, inspect the data you have been given. There is a wide variety of topics and formats available. Following the instructions from [Exercise 3](Integration3LabExercises\3.04.Exercise3.md), open some of these files in the FME Data Inspector to see what attributes they have.

More data is available from the [City of Vancouver Open Data catalogue](http://data.vancouver.ca/datacatalogue/index.htm).

Topic|Format|Location (FMEData2018\Data\...)|
--|--|--
Addresses|Esri Geodatabase|Addresses\Addresses.gdb
Building Footprints|SpatialLite Database or AutoCAD DWG|Engineering\BuildingFootprints\building_footprints.sl3 or C:\FMEData2018\Data\Parcels\BuildingFootprints.dwg
Bike Paths|Esri Shapefile|Transportation\Cycling\BikePaths*.shp|
Business Licenses|Excel Spreadsheet|Planning\BusinessLicenses.xlsx
City Grid|Geography Markup Language|Boundaries\CityGrid.gml
City-owned Properties|Esri Shapefile|Parcels\CityProperties\CityProperties.shp
Coastal Zones|Geography Markup Language|Boundaries\CoastalZones\CoastalZones.gml
Community Resources|Esri Geodatabase|CommunityMapping\CommunityMap.gdb
Crime|Comma Separated Values|Emergency\Crime.csv
Drinking Fountains|Comma-separated Values|Engineering\DrinkingFountains.csv
Election Results|Excel Spreadsheet|Elections\ElectionResults.xls
Election Voting Districts|Geography Markup Language|Elections\ElectionVoting.gml
Elevation|Digital Elevation Model|ElevationModel\DEM-Full.dem
Firehalls with Zones|Geography Markup Language|Emergency\FireHallsWithZones.gml
Forward Sortation Areas (for postcode)|Esri Shapefile|Addresses\ForwardSortationAreas.shp
Land Boundary|Esri Shapefile|Boundaries\LandBoundary\VancouverLandBoundary.shp
Neighborhoods|Google Keyhole Markup Language|Boundaries\VancouverNeighborhoods.kml
Orthophotos (scale corrected aerial photographs)|TIF|Orthophotos\*.tif
Parcels|AutoCAD DWG|Parcels\Parcels.dwg
Parking Meters|MapInfo TAB|Transportation\Parking\Meters.tab
Parking Tickets|Comma-separated Values|Transportation\Parking\ParkingTickets.csv
Parks|MapInfo TAB|Parks\Parks.tab
Planning Restrictions (Business Improvement Areas, Historic Areas, Noise Control Areas, and View Cones)|OCG Geopackage|Planning\PlanningRestrictions.gpkg
Point Cloud (LiDAR)|LAS|PointClouds\CoV*.laz
Public Art|Excel Spreadsheet|Culture\PublicArt.xlsx
Public Trees|Comma-separated Values|Parks\Parks.tab
Roads|AutoCAD DWG or Microstation DGN|Transportation\CompleteRoads.dwg or RoadsDGN.dgn
Street Lighting|AutoCAD DWG and Microstation DGN|Engineering\StreetLighting.dwg and StreetLightingDGN.dgn
Traffic Signals|AutoCAD DWG and Microstation DGN|Engineering\TrafficSignals.dwg and TrafficSignalsDGN.dgn
Zoning|MapInfo TAB|Zoning\Zones.tab
Zoning Descriptions|Adobe PDF|Zoning\ZoneDescriptions.pdf

### Common Procedures

While many datasets will display in an intuitive manner when read using FME defaults, some formats require additional steps to control how they are read. In this section we will walk through a few common procedures that can help when reading some of the open Vancouver data. You can skip this section and go straight into your analysis if you want, referring back to this section if you run into any roadblocks.

#### Reading (X, Y) Coordinates as Points

If you add any CSV readers, you might notice they are imported without geometry. For example, adding the DrinkingFountains.csv file with default settings just adds features with string attributes. In order to be read as point geometry, FME must be told which columns contain the x and y coordinates of the data. There are two ways to do this:

1. When creating the reader, click Parameters and look at the Attributes table at the bottom of the window. The x_coord and y_coord columns are just being read as strings, not coordinates. To change this, change the Attribute Definition button from Automatic to Manual. Then use the dropdown in the Type column of the Attributes table to change x_coord to x_coordinate and y_coord to y_coordinate.

2. You could instead add the reader with default parameters and then attach a VertexCreator transformer to the reader. This creates point geometry from an x and y coordinate attribute. For DrinkingFountains.csv you would open the VertexCreator parameters and for X Value select x_coord and for Y Value select y_coord.

**Note**: even if you have point geometry, some file formats like CSV do not store coordinate system information. You can refer to the [City of Vancouver metadata](http://data.vancouver.ca/datacatalogue/index.htm) to look up the coordinate system, or chances are it is stored as either latitude and longitude (LL84), UTM Zone 10N (UTM83-10), or BC Albers (BCALB-83 or NAD83.BC/Albers). Once you have identified the correct system you can set it under Navigator | Reader | Coordinate System, or under Coordinate System in the dialog box when you are adding a Reader. Refer to [Exercise 6](Integration3LabExercises\3.12.Exercise6.md) for more information.

#### Individual Versus Merged Feature Types

Some datasets contain more than one feature type. For example, if you add CommunityMapping.gdb with the default settings you will be presented with a Feature Types To Read dialog. Here you can select which layers from the geodatabase you wish to read in as feature types.

When you have data like this you can choose to read the data as individual or merged feature types. This option appears only in the Add Reader dialog when you initially add a reader. It cannot be changed after the fact without removing feature types.

If you choose individual feature types each layer (or level, table, etc. depending on the format) will be added as a separate feature type. If you choose merged feature types the reader will combine all the layers into one feature type named &lt;All&gt;. This can be useful if you don't care about the distinction between layers and just want all the features grouped together.

#### Reading Attributes in CAD Data (other data types relevant?)

Some formats do not store attributes in a straight-forward way. One example is CAD data. Because this format is designed for creating digital technical drawings, the features are not by default stored with attributes as in a GIS. However, they can store attributes as "extended entity data."

This has implications for reading CAD data. For example, if you add a Autodesk AutoCAD DWG/DXF reader and choose C:\FMEData2018\Data\Transportation\CompleteRoads.dwg, by default you will only read geometry. However, if you select Parameters | Group Entities By | Attribute Schema in the reader dialog, FME will read the geometry and associate it with each feature's extended entity data. This allows you to use these attributes in your analysis. You can see this in action if you inspect the reader with the default (Parameters | Group Entities By | Layer Name) and compare it to a reader with Parameters | Group Entities By | Attribute Schema. The former will have an empty column &lt;no schema&gt; in Table View and the latter will have a series of attributes.

There are other complicating factors in reading AutoCAD data. You can check out our [Getting Started with AutoCAD](https://knowledge.safe.com/articles/22968/getting-started-with-autocad.html) series if you want to learn more.

#### Joining Features

By default, bringing two data streams together in FME **does not** merge data. Instead, data is combined or accumulated. You may know this as a union of data.

In order to merge data you have to carry out a join. There are two major kinds of joins in FME: key-based and spatially-based joins. Key-based joins connect two data sets based on a shared unique key, e.g. an ID number, a census tract ID, or a street address. Spatially-based joins connect two data sets based on spatial location, e.g. giving the attributes of census tract polygons to point locations of businesses that are contained by the tracts.

There are many transformers you can use in FME to carry out these operations. Here we will just show two of the most common join operations. For more you can refer to this [joiner transformer article and flowchart](https://knowledge.safe.com/articles/34619/working-with-database-transformers-1.html).

**Key-based joins with the FeatureJoiner**

The FeatureJoiner transformer uses SQL join terminology to combine two data sets based on a shared unique key. The default Join Mode is an Inner join. For an inner join you select a "left" attribute from one data stream and a "right" attribute from another. The streams will be combined by adding the right features' attributes to the right side of the left features' attribute table. Only features with matching keys will be merged.

**Spatially-based joins with Overlayer transformers**

FME comes with many Overlayer transformers:
- AreaOnAreaOverlayer
- LineOnAreaOverlayer
- LineOnLineOverlayer
- PointOnAreaOverlayer
- PointOnLineOverlayer
- PointOnPointOverlayer
- SurfaceOnSurfaceOverlayer
- VectorOnRasterOverlayer

These transformers overlay two data streams of geometry. By default they simply count the number of overlaps in each stream and add a new attribute to both layers called _overlaps. However, if you change the settings under Attribute Accumulation | Merge Attributes you can combine attributes to join the data. For example, if you use VancouverNeighborhoods.kml as the polygon and DrinkingFountains.csv as the points (making sure they share the same coordinate system), and you check Merge Attributes, the polygons will get the attributes of the first point they overlap and the points will get the attributes of the neighborhood polygon they overlap. With an operation like this you can integrate data between layers.

#### Creating Charts and Reports

One easy way to show the results of your data integration is to create a visualization. FME has several built-in transformers that can help here. ChartGenerator can create charts. Simply add a ChartGenerator, pick your chart type, and select an attribute to analyze.

You can also easily create HTML reports using the HTMLReportGenerator. You can add elements to your page by clicking in the Page Contents table and adding a new piece of content from the dropdown menu. Each content type has its own options for you to fill in and can be dynamically created by using attributes. For example, if you have joined some data sets together using an Overlayer transformer and then calculated some average values using StatisticsCalculator, you can create a table of those values here. You can use Group By to split up your analysis by groups. Finally, don't forget to write the content of the HTMLReportGenerator out to an HTML writer. Once you do that you can open the resulting HTML file in a web browser.

#### Creating Raster Maps using MapnikRasterizer

Check out this [blog post for FME cartography tips](https://blog.safe.com/2017/12/cartography/) or this article on the [Mapnik Rasterizer](https://knowledge.safe.com/articles/1092/introduction-to-mapnikrasterizer.html).

#### Creating Labels using LabelPointReplacer

We covered creating labels in [Exercise 4](Integration3LabExercises\3.10.Exercise4.md). Refer to that exercise if you run into problems creating labels for your map. There are a few key points to remember:
- You can create labels combining multiple attributes using the StringConcatenator transformer.
- The label height is in the units of your data, so it depends on the coordinate system. You can check the linear units of your data by opening it in FME Data Inspector, selecting a feature, and looking in the Feature Information window. One of the attributes displayed is Coordinate System. Click on the link there (e.g. UTM83-10) and a Coordinate Systems Properties window with more information about the system opens. Here you can find the UNIT information, e.g. for UTM83-10, UNIT: METER.

#### Rejected Features?

You might encounter this error message in your log:

<font color="red">```Termination Message: '{TRANSFORMER NAME} output a <Rejected> feature.  To continue translation when features are rejected, change 'Workspace Parameters' > Translation > 'Rejected Feature Handling' to 'Continue Translation''```</font>

This means that one of your transformers rejected a feature (the message above was edited to use a placeholder `{TRANSFORMER NAME}`). Rejected features can sometimes mean something is wrong with your workspace, especially if a transformer is outputting only rejected features. However, in some cases rejected features are to be expected. For this reason FME gives you the option to decide how to handle rejected features. See this [section of our training manual]({{ book.basic_link }}DesktopBasic3WorkspaceDesign/3.03.RejectedPorts.html) for more information.

## Business Intelligence

?

## Web-based Data

- Whale sightings (modeled from https://catalogue.data.gov.bc.ca/dataset/distribution-of-killer-whales)
- Could do something like:
  - Generate heatmap from sightings
  - Buffer ferry routes
  - Calculate best ferry route to see whales
- Could generate local web map

<br>**1) Set Up Workspace**
The first step in any FME project is to set up your initial workspace. Choose one dataset you wish to use to create a reader and for your writer choose Esri Geodatabase. In this example we'll start with X.

# Outline
- Inspect Data
- Set Up Workspace
  - Generate
  - R/W parameters
  - Run
  - Inspect

# Notes
- Show point creation from xy
- Extra skills
  - Feature caching and partial runs
  - Merged versus individual feature types
    - fme_feature_type format attribute (good for merged feature types)

# Local government case using Vancouver data
- Addresses
- Boundaries
- Community Mapping (base?)
- Culture (public art)
- Elevation model (DEM)
- Emergency (all)
- Engineering
- Parcels
- Parks
- Planning
- Transportation
- Zoning
- Read Crime live? Could point to URL - maybe for all?

## Web-based formats/data
- JSON and GeoJSON
- Petra and Dean
